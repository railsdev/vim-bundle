class RemindersWorker
  include Sidekiq::Worker
  sidekiq_options :retry => 5

  def perform
    scheduled_reminders = ScheduledReminder.includes(:reminder).where({ run_at: (Time.now - 15.minutes)..(Time.now + 59.second), is_active: true}).order(:run_at)
    # puts scheduled_reminders.explain.inspect
    scheduled_reminders.all.each do |sr|
      reminder = sr.reminder
      if reminder.queued_schedules_count.to_i.zero?
        reminder.clean_all_scheduled_reminders
        reminder.set_up_new_reminder_schedules
      else
        reminder.notify
        sr.update_attribute(:is_active, false)
      end
    end
  end
end
