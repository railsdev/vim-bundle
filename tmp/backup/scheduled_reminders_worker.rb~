class ScheduledRemindersWorker
  include Sidekiq::Worker
  sidekiq_options :retry => 5

  def perform(reminder_id, schedule_occurrences)
    @reminder = Reminder.find(reminder_id)
    @schedule_occurrences = schedule_occurrences
    line_up_all_reminders
  end

  def line_up_all_reminders
    scheduled_reminders_array = []
    @schedule_occurrences.each do |o_dtime| 
      scheduled_reminders_array << {run_at: o_dtime, is_active: 1}
    end
    @reminder.scheduled_reminders.create(scheduled_reminders_array)
    @reminder.update_column(:last_schedule_on, @reminder.scheduled_reminders.order(:run_at).last.run_at)
    @reminder.update_column(:queued_schedules_count, @reminder.scheduled_reminders.count)
    @reminder.update_column(:is_scheduled, true)
  end
end
