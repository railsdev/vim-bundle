# == Schema Information
#
# Table name: scheduled_reminders
#
#  id          :integer          not null, primary key
#  reminder_id :integer
#  run_at      :datetime
#  created_at  :datetime
#  updated_at  :datetime
#  is_active   :boolean          default(TRUE)
#

class ScheduledReminder < ActiveRecord::Base
  belongs_to :reminder
  has_one :consumer_medication, through: :reminder
  has_one :consumer, through: :reminder
  has_one :consumer_compliance 
  scope :pending_for, lambda { |date_range, consumer_id| joins(:reminder).includes(:consumer_medication => [:consumer_product])
                                   .where(:run_at => date_range, 
                                          :is_active => 1, 
                                          'reminders.consumer_id' => consumer_id, 
                                          'reminders.is_active' => 1)}

  def as_json(options={})
    {
      id: id,
      drug_name: consumer_medication.consumer_drug.drug_name_short,
      short_drug_name: consumer_medication.consumer_drug.drug_name_short,
      reminder_id: reminder_id,
      is_active: is_active,
      time: run_at.in_time_zone(consumer.consumer_setting.time_zone).to_s(:time),
      full_time: run_at.in_time_zone(consumer.consumer_setting.time_zone),
      compliance_status: consumer_compliance.try(:status) || 'pending',
      consumer_medication_id: consumer_medication.id
    }
  end
end
